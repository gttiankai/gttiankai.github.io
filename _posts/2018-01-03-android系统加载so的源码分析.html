---
date: 2018-01-03
tags: 
- Android
author: tiankai
layout: post
title: Android系统加载so的源码分析
excerpt: Android 加载so
categories: 
- Android
---

<div id="outline-container-orgf398470" class="outline-2">
<h2 id="orgf398470">dlopen的源码分析</h2>
<div class="outline-text-2" id="text-orgf398470">
<p>
在Android系统中,我们知道对so的加载是通过两个API调用实现的,这两个API是：
</p>
<ol class="org-ol">
<li>System.loadLibrary(String libName)</li>
<li>System.load(String pathName)</li>
</ol>
<p>
以上两个API的底层实现都是基于dlopen实现的.要想弄明白dlopen的实现,必须研究dlopen的源码实现.
</p>

<p>
首先dlopen的实现定义在源码(<i>/bionic/linker/dlfcn.cpp</i>, 本文讨论的源码是基于Android5.0.0的版本)
</p>
<div class="org-src-container">
<pre class="src src-C++"><span style="color: #ce537a; font-weight: bold;">void</span>* <span style="color: #bc6ec5; font-weight: bold;">dlopen</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold; font-style: italic;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span>* <span style="color: #7590db;">filename</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">flags</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
  <span style="color: #4f97d7; font-weight: bold; font-style: italic;">return</span> dlopen_ext<span style="color: #bc6ec5;">(</span>filename, flags, <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<p>
dlopen直接调用dlopen<sub>ext函数</sub>.
</p>
<div class="org-src-container">
<pre class="src src-C++"><span style="color: #4f97d7; font-weight: bold; font-style: italic;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span>* <span style="color: #bc6ec5; font-weight: bold;">dlopen_ext</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold; font-style: italic;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span>* <span style="color: #7590db;">filename</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">flags</span>, <span style="color: #4f97d7; font-weight: bold; font-style: italic;">const</span> <span style="color: #ce537a; font-weight: bold;">android_dlextinfo</span>* <span style="color: #7590db;">extinfo</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
  ScopedPthreadMutexLocker <span style="color: #ce537a; font-weight: bold;">locker</span><span style="color: #bc6ec5;">(</span>&amp;<span style="color: #7590db;">g_dl_mutex</span><span style="color: #bc6ec5;">)</span>;
  <span style="color: #ce537a; font-weight: bold;">soinfo</span>* <span style="color: #7590db;">result</span> = do_dlopen<span style="color: #bc6ec5;">(</span>filename, flags, extinfo<span style="color: #bc6ec5;">)</span>;
  <span style="color: #4f97d7; font-weight: bold; font-style: italic;">if</span> <span style="color: #bc6ec5;">(</span>result == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
    __bionic_format_dlerror<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"dlopen failed"</span>, linker_get_error_buffer<span style="color: #67b11d;">()</span><span style="color: #2d9574;">)</span>;
    <span style="color: #4f97d7; font-weight: bold; font-style: italic;">return</span> <span style="color: #a45bad;">NULL</span>;
  <span style="color: #bc6ec5;">}</span>
  <span style="color: #4f97d7; font-weight: bold; font-style: italic;">return</span> result;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<p>
dlopen<sub>ext函数主要用来调用do</sub><sub>dlopen函数</sub>.
</p>
<div class="org-src-container">
<pre class="src src-C++"><span style="color: #ce537a; font-weight: bold;">soinfo</span>* <span style="color: #bc6ec5; font-weight: bold;">do_dlopen</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold; font-style: italic;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span>* <span style="color: #7590db;">name</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">flags</span>, <span style="color: #4f97d7; font-weight: bold; font-style: italic;">const</span> <span style="color: #ce537a; font-weight: bold;">android_dlextinfo</span>* <span style="color: #7590db;">extinfo</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
  <span style="color: #4f97d7; font-weight: bold; font-style: italic;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">flags</span> &amp; ~<span style="color: #67b11d;">(</span>RTLD_NOW|RTLD_LAZY|RTLD_LOCAL|RTLD_GLOBAL|RTLD_NOLOAD<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
    DL_ERR<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"invalid flags to dlopen: %x"</span>, flags<span style="color: #2d9574;">)</span>;
    <span style="color: #4f97d7; font-weight: bold; font-style: italic;">return</span> <span style="color: #a45bad;">NULL</span>;
  <span style="color: #bc6ec5;">}</span>
  <span style="color: #4f97d7; font-weight: bold; font-style: italic;">if</span> <span style="color: #bc6ec5;">(</span>extinfo != <span style="color: #a45bad;">NULL</span> &amp;&amp; <span style="color: #2d9574;">(</span><span style="color: #67b11d;">(</span>extinfo-&gt;flags &amp; ~<span style="color: #b1951d;">(</span>ANDROID_DLEXT_VALID_FLAG_BITS<span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
    DL_ERR<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"invalid extended flags to android_dlopen_ext: %"</span> PRIx64, extinfo-&gt;flags<span style="color: #2d9574;">)</span>;
    <span style="color: #4f97d7; font-weight: bold; font-style: italic;">return</span> <span style="color: #a45bad;">NULL</span>;
  <span style="color: #bc6ec5;">}</span>
  protect_data<span style="color: #bc6ec5;">(</span>PROT_READ | PROT_WRITE<span style="color: #bc6ec5;">)</span>;
  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#29983;&#25104;soinfo&#32467;&#26500;&#20307;</span>
  <span style="color: #ce537a; font-weight: bold;">soinfo</span>* <span style="color: #7590db;">si</span> = find_library<span style="color: #bc6ec5;">(</span>name, flags, extinfo<span style="color: #bc6ec5;">)</span>;
  <span style="color: #4f97d7; font-weight: bold; font-style: italic;">if</span> <span style="color: #bc6ec5;">(</span>si != <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
    <span style="color: #2aa1ae; background-color: #292e34;">//</span><span style="color: #2aa1ae; background-color: #292e34;">&#35843;&#29992;so&#20013;&#30340;&#26500;&#36896;&#26041;&#27861;</span>
    si-&gt;CallConstructors<span style="color: #2d9574;">()</span>;
  <span style="color: #bc6ec5;">}</span>
  protect_data<span style="color: #bc6ec5;">(</span>PROT_READ<span style="color: #bc6ec5;">)</span>;
  <span style="color: #4f97d7; font-weight: bold; font-style: italic;">return</span> si;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<p>
以上的代码中关键的函数是find<sub>library.该函数的定义如下</sub>:
</p>
<div class="org-src-container">
<pre class="src src-C++"><span style="color: #4f97d7; font-weight: bold; font-style: italic;">static</span> <span style="color: #ce537a; font-weight: bold;">soinfo</span>* <span style="color: #bc6ec5; font-weight: bold;">find_library</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold; font-style: italic;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span>* <span style="color: #7590db;">name</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">dlflags</span>, <span style="color: #4f97d7; font-weight: bold; font-style: italic;">const</span> <span style="color: #ce537a; font-weight: bold;">android_dlextinfo</span>* <span style="color: #7590db;">extinfo</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
  <span style="color: #ce537a; font-weight: bold;">soinfo</span>* <span style="color: #7590db;">si</span> = find_library_internal<span style="color: #bc6ec5;">(</span>name, dlflags, extinfo<span style="color: #bc6ec5;">)</span>;
  <span style="color: #4f97d7; font-weight: bold; font-style: italic;">if</span> <span style="color: #bc6ec5;">(</span>si != <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
    si-&gt;ref_count++;
  <span style="color: #bc6ec5;">}</span>
  <span style="color: #4f97d7; font-weight: bold; font-style: italic;">return</span> si;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<p>
关键的代码在 find<sub>library</sub><sub>internal函数中</sub>.
</p>
<div class="org-src-container">
<pre class="src src-C++"><span style="color: #4f97d7; font-weight: bold; font-style: italic;">static</span> <span style="color: #ce537a; font-weight: bold;">soinfo</span>* <span style="color: #bc6ec5; font-weight: bold;">find_library_internal</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold; font-style: italic;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span>* <span style="color: #7590db;">name</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">dlflags</span>, <span style="color: #4f97d7; font-weight: bold; font-style: italic;">const</span> <span style="color: #ce537a; font-weight: bold;">android_dlextinfo</span>* <span style="color: #7590db;">extinfo</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
  <span style="color: #4f97d7; font-weight: bold; font-style: italic;">if</span> <span style="color: #bc6ec5;">(</span>name == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
    <span style="color: #4f97d7; font-weight: bold; font-style: italic;">return</span> somain;
  <span style="color: #bc6ec5;">}</span>
  <span style="color: #2aa1ae; background-color: #292e34;">//</span><span style="color: #2aa1ae; background-color: #292e34;">WARNING: &#20174;&#24050;&#32463;&#22312;&#21152;&#36733;&#30340;&#34920;&#20013;&#36827;&#34892;&#21152;&#36733;so</span>
  <span style="color: #ce537a; font-weight: bold;">soinfo</span>* <span style="color: #7590db;">si</span> = find_loaded_library_by_name<span style="color: #bc6ec5;">(</span>name<span style="color: #bc6ec5;">)</span>;

  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Library might still be loaded, the accurate detection</span>
  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">of this fact is done by load_library</span>
  <span style="color: #4f97d7; font-weight: bold; font-style: italic;">if</span> <span style="color: #bc6ec5;">(</span>si == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
    TRACE<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"[ '%s' has not been found by name.  Trying harder...]"</span>, name<span style="color: #2d9574;">)</span>;
    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#22914;&#26524;&#36825;&#20010;so&#27809;&#26377;&#21152;&#36733;&#36807;,&#21017;&#37325;&#26032;&#23545;so&#36827;&#34892;&#21152;&#36733;.</span>
    si = load_library<span style="color: #2d9574;">(</span>name, dlflags, extinfo<span style="color: #2d9574;">)</span>;
  <span style="color: #bc6ec5;">}</span>

  <span style="color: #4f97d7; font-weight: bold; font-style: italic;">if</span> <span style="color: #bc6ec5;">(</span>si != <span style="color: #a45bad;">NULL</span> &amp;&amp; <span style="color: #2d9574;">(</span>si-&gt;flags &amp; FLAG_LINKED<span style="color: #2d9574;">)</span> == <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
    DL_ERR<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"recursive link to \"%s\""</span>, si-&gt;name<span style="color: #2d9574;">)</span>;
    <span style="color: #4f97d7; font-weight: bold; font-style: italic;">return</span> <span style="color: #a45bad;">NULL</span>;
  <span style="color: #bc6ec5;">}</span>

  <span style="color: #4f97d7; font-weight: bold; font-style: italic;">return</span> si;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<p>
我们先来看find<sub>loaded</sub><sub>library</sub><sub>by</sub><sub>name函数的实现,等研究查找so的功能,然后在对load</sub><sub>library函数进行加载</sub>.
</p>
<div class="org-src-container">
<pre class="src src-C++"><span style="color: #4f97d7; font-weight: bold; font-style: italic;">static</span> <span style="color: #ce537a; font-weight: bold;">soinfo</span> *<span style="color: #bc6ec5; font-weight: bold;">find_loaded_library_by_name</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold; font-style: italic;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span>* <span style="color: #7590db;">name</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
  <span style="color: #4f97d7; font-weight: bold; font-style: italic;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span>* <span style="color: #7590db;">search_name</span> = SEARCH_NAME<span style="color: #bc6ec5;">(</span>name<span style="color: #bc6ec5;">)</span>;
  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">solist &#26159;&#19968;&#20010;&#20840;&#23616;&#30340;soinfo&#30340;&#38142;&#34920;</span>
  <span style="color: #4f97d7; font-weight: bold; font-style: italic;">for</span> <span style="color: #bc6ec5;">(</span><span style="color: #ce537a; font-weight: bold;">soinfo</span>* <span style="color: #7590db;">si</span> = solist; si != <span style="color: #a45bad;">NULL</span>; si = si-&gt;next<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
    <span style="color: #4f97d7; font-weight: bold; font-style: italic;">if</span> <span style="color: #2d9574;">(</span><span style="color: #a45bad;">!</span>strcmp<span style="color: #67b11d;">(</span>search_name, si-&gt;name<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      <span style="color: #4f97d7; font-weight: bold; font-style: italic;">return</span> si;
    <span style="color: #2d9574;">}</span>
  <span style="color: #bc6ec5;">}</span>
  <span style="color: #4f97d7; font-weight: bold; font-style: italic;">return</span> <span style="color: #a45bad;">NULL</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<p>
从上面的代码中可以看到,find<sub>loaded</sub><sub>library</sub><sub>by</sub><sub>name通过比对so的名称在solist表中进行查找.这个so的名称是怎么来得到呢</sub>?
</p>
<div class="org-src-container">
<pre class="src src-C++"><span style="color: #bc6ec5;">#if</span> <span style="color: #bc6ec5;">defined</span><span style="color: #4f97d7;">(</span>__LP64__<span style="color: #4f97d7;">)</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #bc6ec5; font-weight: bold;">SEARCH_NAME</span><span style="color: #4f97d7;">(</span><span style="color: #7590db;">x</span><span style="color: #4f97d7;">)</span> x
<span style="color: #bc6ec5;">#else</span>
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Nvidia drivers are relying on the bug:</span>
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">http://code.google.com/p/android/issues/detail?id=6670</span>
<span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">so we continue to use base-name lookup for lp32</span>
<span style="color: #4f97d7; font-weight: bold; font-style: italic;">static</span> <span style="color: #4f97d7; font-weight: bold; font-style: italic;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span>* <span style="color: #bc6ec5; font-weight: bold;">get_base_name</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold; font-style: italic;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span>* <span style="color: #7590db;">name</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
  <span style="color: #4f97d7; font-weight: bold; font-style: italic;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span>* <span style="color: #7590db;">bname</span> = strrchr<span style="color: #bc6ec5;">(</span>name, <span style="color: #2d9574;">'/'</span><span style="color: #bc6ec5;">)</span>;
  <span style="color: #4f97d7; font-weight: bold; font-style: italic;">return</span> bname ? bname + <span style="color: #a45bad;">1</span> : name;
<span style="color: #4f97d7;">}</span>
<span style="color: #bc6ec5;">#define</span> <span style="color: #bc6ec5; font-weight: bold;">SEARCH_NAME</span><span style="color: #4f97d7;">(</span><span style="color: #7590db;">x</span><span style="color: #4f97d7;">)</span> get_base_name<span style="color: #4f97d7;">(</span>x<span style="color: #4f97d7;">)</span>
<span style="color: #bc6ec5;">#endif</span>
</pre>
</div>
<p>
在非64位机器的条件下,SEARCH<sub>NAME宏定义的实现都是get</sub><sub>base</sub><sub>name函数.该函数主要获取的是so名称的basename,也就是之后so的名称,不包含so的路径.find</sub><sub>loaded</sub><sub>library</sub><sub>by</sub><sub>name的实现在不同的Android版本中是不同的.在Android6.0的版本中该函数就改了个名称,并且具体的实现也不同了</sub>.
</p>
<div class="org-src-container">
<pre class="src src-C++"><span style="color: #4f97d7; font-weight: bold; font-style: italic;">static</span> <span style="color: #ce537a; font-weight: bold;">bool</span> <span style="color: #bc6ec5; font-weight: bold;">find_loaded_library_by_soname</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold; font-style: italic;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span>* <span style="color: #7590db;">name</span>, <span style="color: #ce537a; font-weight: bold;">soinfo</span>** <span style="color: #7590db;">candidate</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
  *candidate = <span style="color: #a45bad;">nullptr</span>;

  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Ignore filename with path.</span>
  <span style="color: #4f97d7; font-weight: bold; font-style: italic;">if</span> <span style="color: #bc6ec5;">(</span>strchr<span style="color: #2d9574;">(</span>name, <span style="color: #2d9574;">'/'</span><span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">nullptr</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
    <span style="color: #4f97d7; font-weight: bold; font-style: italic;">return</span> <span style="color: #a45bad;">false</span>;
  <span style="color: #bc6ec5;">}</span>

  <span style="color: #ce537a; font-weight: bold;">uint32_t</span> <span style="color: #7590db;">target_sdk_version</span> = get_application_target_sdk_version<span style="color: #bc6ec5;">()</span>;

  <span style="color: #4f97d7; font-weight: bold; font-style: italic;">for</span> <span style="color: #bc6ec5;">(</span><span style="color: #ce537a; font-weight: bold;">soinfo</span>* <span style="color: #7590db;">si</span> = solist; si != <span style="color: #a45bad;">nullptr</span>; si = si-&gt;next<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
    <span style="color: #4f97d7; font-weight: bold; font-style: italic;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span>* <span style="color: #7590db;">soname</span> = si-&gt;get_soname<span style="color: #2d9574;">()</span>;
    <span style="color: #4f97d7; font-weight: bold; font-style: italic;">if</span> <span style="color: #2d9574;">(</span>soname != <span style="color: #a45bad;">nullptr</span> &amp;&amp; <span style="color: #67b11d;">(</span>strcmp<span style="color: #b1951d;">(</span>name, soname<span style="color: #b1951d;">)</span> == <span style="color: #a45bad;">0</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
      <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">If the library was opened under different target sdk version</span>
      <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">skip this step and try to reopen it. The exceptions are</span>
      <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">"libdl.so" and global group. There is no point in skipping</span>
      <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">them because relocation process is going to use them</span>
      <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">in any case.</span>
      <span style="color: #ce537a; font-weight: bold;">bool</span> <span style="color: #7590db;">is_libdl</span> = si == solist;
      <span style="color: #4f97d7; font-weight: bold; font-style: italic;">if</span> <span style="color: #67b11d;">(</span>is_libdl || <span style="color: #b1951d;">(</span>si-&gt;get_dt_flags_1<span style="color: #4f97d7;">()</span> &amp; DF_1_GLOBAL<span style="color: #b1951d;">)</span> != <span style="color: #a45bad;">0</span> ||
          <span style="color: #a45bad;">!</span>si-&gt;is_linked<span style="color: #b1951d;">()</span> || si-&gt;get_target_sdk_version<span style="color: #b1951d;">()</span> == target_sdk_version<span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
        *candidate = si;
        <span style="color: #4f97d7; font-weight: bold; font-style: italic;">return</span> <span style="color: #a45bad;">true</span>;
      <span style="color: #67b11d;">}</span> <span style="color: #4f97d7; font-weight: bold; font-style: italic;">else</span> <span style="color: #4f97d7; font-weight: bold; font-style: italic;">if</span> <span style="color: #67b11d;">(</span>*candidate == <span style="color: #a45bad;">nullptr</span><span style="color: #67b11d;">)</span> <span style="color: #67b11d;">{</span>
        <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">for the different sdk version - remember the first library.</span>
        *candidate = si;
      <span style="color: #67b11d;">}</span>
    <span style="color: #2d9574;">}</span>
  <span style="color: #bc6ec5;">}</span>

  <span style="color: #4f97d7; font-weight: bold; font-style: italic;">return</span> <span style="color: #a45bad;">false</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<p>
从上面的代码中可以看出,在Android6.0的版本中,查找so的名称和以前的版本中是不同的,并不是仅仅查找so的名称,也要加上so的路径.总结一下:
</p>
<ol class="org-ol">
<li>在android6.0以下的版本中(32位系统),使用so的名称进行查找.</li>
<li>在android6.0及以上的版本中,使用so的路径进行查找.</li>
</ol>

<p>
接下来继续看load<sub>library</sub>
</p>
<div class="org-src-container">
<pre class="src src-C++"><span style="color: #4f97d7; font-weight: bold; font-style: italic;">static</span> <span style="color: #ce537a; font-weight: bold;">soinfo</span>* <span style="color: #bc6ec5; font-weight: bold;">load_library</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold; font-style: italic;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span>* <span style="color: #7590db;">name</span>, <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">dlflags</span>, <span style="color: #4f97d7; font-weight: bold; font-style: italic;">const</span> <span style="color: #ce537a; font-weight: bold;">android_dlextinfo</span>* <span style="color: #7590db;">extinfo</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">fd</span> = -<span style="color: #a45bad;">1</span>;
    <span style="color: #ce537a; font-weight: bold;">ScopedFd</span> <span style="color: #7590db;">file_guard</span><span style="color: #bc6ec5;">(</span>-<span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold; font-style: italic;">if</span> <span style="color: #bc6ec5;">(</span>extinfo != <span style="color: #a45bad;">NULL</span> &amp;&amp; <span style="color: #2d9574;">(</span>extinfo-&gt;flags &amp; ANDROID_DLEXT_USE_LIBRARY_FD<span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
      fd = extinfo-&gt;library_fd;
    <span style="color: #bc6ec5;">}</span> <span style="color: #4f97d7; font-weight: bold; font-style: italic;">else</span> <span style="color: #bc6ec5;">{</span>
      <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Open the file.</span>
      fd = open_library<span style="color: #2d9574;">(</span>name<span style="color: #2d9574;">)</span>;
      <span style="color: #4f97d7; font-weight: bold; font-style: italic;">if</span> <span style="color: #2d9574;">(</span>fd == -<span style="color: #a45bad;">1</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
        DL_ERR<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"library \"%s\" not found"</span>, name<span style="color: #67b11d;">)</span>;
        <span style="color: #4f97d7; font-weight: bold; font-style: italic;">return</span> <span style="color: #a45bad;">NULL</span>;
      <span style="color: #2d9574;">}</span>

      file_guard.reset<span style="color: #2d9574;">(</span>fd<span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #ce537a; font-weight: bold;">ElfReader</span> <span style="color: #7590db;">elf_reader</span><span style="color: #bc6ec5;">(</span>name, fd<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold; font-style: italic;">struct</span> <span style="color: #ce537a; font-weight: bold;">stat</span> <span style="color: #7590db;">file_stat</span>;
    <span style="color: #4f97d7; font-weight: bold; font-style: italic;">if</span> <span style="color: #bc6ec5;">(</span>TEMP_FAILURE_RETRY<span style="color: #2d9574;">(</span>fstat<span style="color: #67b11d;">(</span>fd, &amp;file_stat<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
      DL_ERR<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"unable to stat file for the library %s: %s"</span>, name, strerror<span style="color: #67b11d;">(</span>errno<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span>;
      <span style="color: #4f97d7; font-weight: bold; font-style: italic;">return</span> <span style="color: #a45bad;">NULL</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Check for symlink and other situations where</span>
    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">file can have different names.</span>
    <span style="color: #4f97d7; font-weight: bold; font-style: italic;">for</span> <span style="color: #bc6ec5;">(</span><span style="color: #ce537a; font-weight: bold;">soinfo</span>* <span style="color: #7590db;">si</span> = solist; si != <span style="color: #a45bad;">NULL</span>; si = si-&gt;next<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
      <span style="color: #4f97d7; font-weight: bold; font-style: italic;">if</span> <span style="color: #2d9574;">(</span>si-&gt;get_st_dev<span style="color: #67b11d;">()</span> != <span style="color: #a45bad;">0</span> &amp;&amp;
          si-&gt;get_st_ino<span style="color: #67b11d;">()</span> != <span style="color: #a45bad;">0</span> &amp;&amp;
          si-&gt;get_st_dev<span style="color: #67b11d;">()</span> == file_stat.st_dev &amp;&amp;
          si-&gt;get_st_ino<span style="color: #67b11d;">()</span> == file_stat.st_ino<span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
        TRACE<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"library \"%s\" is already loaded under different name/path \"%s\" - will return existing soinfo"</span>, name, si-&gt;name<span style="color: #67b11d;">)</span>;
        <span style="color: #4f97d7; font-weight: bold; font-style: italic;">return</span> si;
      <span style="color: #2d9574;">}</span>
   <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold; font-style: italic;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>dlflags &amp; RTLD_NOLOAD<span style="color: #2d9574;">)</span> != <span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
      <span style="color: #4f97d7; font-weight: bold; font-style: italic;">return</span> <span style="color: #a45bad;">NULL</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">Read the ELF header and load the segments.</span>
    <span style="color: #4f97d7; font-weight: bold; font-style: italic;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">!</span>elf_reader.Load<span style="color: #2d9574;">(</span>extinfo<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold; font-style: italic;">return</span> <span style="color: #a45bad;">NULL</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #ce537a; font-weight: bold;">soinfo</span>* <span style="color: #7590db;">si</span> = soinfo_alloc<span style="color: #bc6ec5;">(</span>SEARCH_NAME<span style="color: #2d9574;">(</span>name<span style="color: #2d9574;">)</span>, &amp;file_stat<span style="color: #bc6ec5;">)</span>;
    <span style="color: #4f97d7; font-weight: bold; font-style: italic;">if</span> <span style="color: #bc6ec5;">(</span>si == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold; font-style: italic;">return</span> <span style="color: #a45bad;">NULL</span>;
    <span style="color: #bc6ec5;">}</span>
    si-&gt;base = elf_reader.load_start<span style="color: #bc6ec5;">()</span>;
    si-&gt;size = elf_reader.load_size<span style="color: #bc6ec5;">()</span>;
    si-&gt;load_bias = elf_reader.load_bias<span style="color: #bc6ec5;">()</span>;
    si-&gt;phnum = elf_reader.phdr_count<span style="color: #bc6ec5;">()</span>;
    si-&gt;phdr = elf_reader.loaded_phdr<span style="color: #bc6ec5;">()</span>;

    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">At this point we know that whatever is loaded @ base is a valid ELF</span>
    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">shared library whose segments are properly mapped in.</span>
    TRACE<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"[ load_library base=%p size=%zu name='%s' ]"</span>,
          <span style="color: #4f97d7; font-weight: bold; font-style: italic;">reinterpret_cast</span><span style="color: #2d9574;">&lt;</span><span style="color: #ce537a; font-weight: bold;">void</span>*<span style="color: #2d9574;">&gt;(</span>si-&gt;base<span style="color: #2d9574;">)</span>, si-&gt;size, si-&gt;name<span style="color: #bc6ec5;">)</span>;

    <span style="color: #4f97d7; font-weight: bold; font-style: italic;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">!</span>soinfo_link_image<span style="color: #2d9574;">(</span>si, extinfo<span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
      soinfo_free<span style="color: #2d9574;">(</span>si<span style="color: #2d9574;">)</span>;
      <span style="color: #4f97d7; font-weight: bold; font-style: italic;">return</span> <span style="color: #a45bad;">NULL</span>;
    <span style="color: #bc6ec5;">}</span>

    <span style="color: #4f97d7; font-weight: bold; font-style: italic;">return</span> si;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<p>
从上面的代码中可以看到,load<sub>library函数的实现比较简单,直接打开需要加载的so文件,然生成新的soinfo的结构体.至此系统已经完成了对soinfo结构体的构造.接下来继续看so的构造函数的调用</sub>.
</p>
<div class="org-src-container">
<pre class="src src-C++"><span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #a45bad;">soinfo</span>::<span style="color: #bc6ec5; font-weight: bold;">CallConstructors</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7;">{</span>
  <span style="color: #4f97d7; font-weight: bold; font-style: italic;">if</span> <span style="color: #bc6ec5;">(</span>constructors_called<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
    <span style="color: #4f97d7; font-weight: bold; font-style: italic;">return</span>;
  <span style="color: #bc6ec5;">}</span>

  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">We set constructors_called before actually calling the constructors, otherwise it doesn't</span>
  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">protect against recursive constructor calls. One simple example of constructor recursion</span>
  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">is the libc debug malloc, which is implemented in libc_malloc_debug_leak.so:</span>
  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">1. The program depends on libc, so libc's constructor is called here.</span>
  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">2. The libc constructor calls dlopen() to load libc_malloc_debug_leak.so.</span>
  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">3. dlopen() calls the constructors on the newly created</span>
  <span style="color: #2aa1ae; background-color: #292e34;">//    </span><span style="color: #2aa1ae; background-color: #292e34;">soinfo for libc_malloc_debug_leak.so.</span>
  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">4. The debug .so depends on libc, so CallConstructors is</span>
  <span style="color: #2aa1ae; background-color: #292e34;">//    </span><span style="color: #2aa1ae; background-color: #292e34;">called again with the libc soinfo. If it doesn't trigger the early-</span>
  <span style="color: #2aa1ae; background-color: #292e34;">//    </span><span style="color: #2aa1ae; background-color: #292e34;">out above, the libc constructor will be called again (recursively!).</span>
  constructors_called = <span style="color: #a45bad;">true</span>;

  <span style="color: #4f97d7; font-weight: bold; font-style: italic;">if</span> <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">(</span>flags &amp; FLAG_EXE<span style="color: #2d9574;">)</span> == <span style="color: #a45bad;">0</span> &amp;&amp; preinit_array != <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
    <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">The GNU dynamic linker silently ignores these, but we warn the developer.</span>
    PRINT<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"\"%s\": ignoring %zd-entry DT_PREINIT_ARRAY in shared library!"</span>,
          name, preinit_array_count<span style="color: #2d9574;">)</span>;
  <span style="color: #bc6ec5;">}</span>

  get_children<span style="color: #bc6ec5;">()</span>.for_each<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">[]</span> <span style="color: #2d9574;">(</span><span style="color: #ce537a; font-weight: bold;">soinfo</span>* <span style="color: #7590db;">si</span><span style="color: #2d9574;">)</span> <span style="color: #2d9574;">{</span>
    si-&gt;CallConstructors<span style="color: #67b11d;">()</span>;
  <span style="color: #2d9574;">}</span><span style="color: #bc6ec5;">)</span>;

  TRACE<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"\"%s\": calling constructors"</span>, name<span style="color: #bc6ec5;">)</span>;

  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">DT_INIT should be called before DT_INIT_ARRAY if both are present.</span>
  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#35843;&#29992;so&#20013;&#30340;init&#20989;&#25968;</span>
  CallFunction<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"DT_INIT"</span>, init_func<span style="color: #bc6ec5;">)</span>;
  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">&#35843;&#29992;so&#20013;&#30340;initarray&#20013;&#30340;&#20989;&#25968;</span>
  CallArray<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"DT_INIT_ARRAY"</span>, init_array, init_array_count, <span style="color: #a45bad;">false</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<p>
CallFunction的代码如下所示:
</p>
<div class="org-src-container">
<pre class="src src-C++"><span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #a45bad;">soinfo</span>::<span style="color: #bc6ec5; font-weight: bold;">CallFunction</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold; font-style: italic;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span>* <span style="color: #7590db;">function_name</span> __unused, <span style="color: #ce537a; font-weight: bold;">linker_function_t</span> <span style="color: #7590db;">function</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
  <span style="color: #2aa1ae; background-color: #292e34;">// </span>
  <span style="color: #4f97d7; font-weight: bold; font-style: italic;">if</span> <span style="color: #bc6ec5;">(</span>function == <span style="color: #a45bad;">NULL</span> || <span style="color: #4f97d7; font-weight: bold; font-style: italic;">reinterpret_cast</span><span style="color: #2d9574;">&lt;</span><span style="color: #ce537a; font-weight: bold;">uintptr_t</span><span style="color: #2d9574;">&gt;(</span>function<span style="color: #2d9574;">)</span> == <span style="color: #4f97d7; font-weight: bold; font-style: italic;">static_cast</span><span style="color: #2d9574;">&lt;</span><span style="color: #ce537a; font-weight: bold;">uintptr_t</span><span style="color: #2d9574;">&gt;(</span>-<span style="color: #a45bad;">1</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
    <span style="color: #4f97d7; font-weight: bold; font-style: italic;">return</span>;
  <span style="color: #bc6ec5;">}</span>

  TRACE<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"[ Calling %s @ %p for '%s' ]"</span>, function_name, function, name<span style="color: #bc6ec5;">)</span>;
  function<span style="color: #bc6ec5;">()</span>;
  TRACE<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"[ Done calling %s @ %p for '%s' ]"</span>, function_name, function, name<span style="color: #bc6ec5;">)</span>;

  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">The function may have called dlopen(3) or dlclose(3), so we need to ensure our data structures</span>
  <span style="color: #2aa1ae; background-color: #292e34;">// </span><span style="color: #2aa1ae; background-color: #292e34;">are still writable. This happens with our debug malloc (see http://b/7941716).</span>
  protect_data<span style="color: #bc6ec5;">(</span>PROT_READ | PROT_WRITE<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<p>
在以上的代码中function是已经复制好的函数.具体的初始化过程在soinfo<sub>link</sub><sub>image函数进行实现.CallArray的实现如下</sub>:
</p>
<div class="org-src-container">
<pre class="src src-C++"><span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #a45bad;">soinfo</span>::<span style="color: #bc6ec5; font-weight: bold;">CallArray</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold; font-style: italic;">const</span> <span style="color: #ce537a; font-weight: bold;">char</span>* <span style="color: #7590db;">array_name</span> __unused, <span style="color: #ce537a; font-weight: bold;">linker_function_t</span>* <span style="color: #7590db;">functions</span>, <span style="color: #ce537a; font-weight: bold;">size_t</span> <span style="color: #7590db;">count</span>, <span style="color: #ce537a; font-weight: bold;">bool</span> <span style="color: #7590db;">reverse</span><span style="color: #4f97d7;">)</span> <span style="color: #4f97d7;">{</span>
  <span style="color: #4f97d7; font-weight: bold; font-style: italic;">if</span> <span style="color: #bc6ec5;">(</span>functions == <span style="color: #a45bad;">NULL</span><span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
    <span style="color: #4f97d7; font-weight: bold; font-style: italic;">return</span>;
  <span style="color: #bc6ec5;">}</span>

  TRACE<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"[ Calling %s (size %zd) @ %p for '%s' ]"</span>, array_name, count, functions, name<span style="color: #bc6ec5;">)</span>;

  <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">begin</span> = reverse ? <span style="color: #bc6ec5;">(</span>count - <span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span> : <span style="color: #a45bad;">0</span>;
  <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">end</span> = reverse ? -<span style="color: #a45bad;">1</span> : count;
  <span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">step</span> = reverse ? -<span style="color: #a45bad;">1</span> : <span style="color: #a45bad;">1</span>;

  <span style="color: #4f97d7; font-weight: bold; font-style: italic;">for</span> <span style="color: #bc6ec5;">(</span><span style="color: #ce537a; font-weight: bold;">int</span> <span style="color: #7590db;">i</span> = begin; i != end; i += step<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
    TRACE<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"[ %s[%d] == %p ]"</span>, array_name, i, functions<span style="color: #67b11d;">[</span>i<span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
    CallFunction<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"function"</span>, functions<span style="color: #67b11d;">[</span>i<span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span>;
  <span style="color: #bc6ec5;">}</span>

  TRACE<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"[ Done calling %s for '%s' ]"</span>, array_name, name<span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<p>
CallArray实际上就是对initarray中的函数逐个的进行调用.调用完成之后,就基本上完成了对so的加载(初始化工作).
</p>
</div>
</div>
